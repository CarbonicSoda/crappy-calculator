(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))r(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const s of a.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&r(s)}).observe(document,{childList:!0,subtree:!0});function n(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerPolicy&&(a.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?a.credentials="include":o.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function r(o){if(o.ep)return;o.ep=!0;const a=n(o);fetch(o.href,a)}})();var i=(t=>(t[t.Prefix=0]="Prefix",t[t.Postfix=1]="Postfix",t[t.Function=2]="Function",t))(i||{}),c=(t=>(t[t.Bracket=0]="Bracket",t[t.Numeral=1]="Numeral",t[t.UnaryOp=2]="UnaryOp",t[t.BinaryOp=3]="BinaryOp",t))(c||{}),l=(t=>(t[t.Root=0]="Root",t[t.Numeral=1]="Numeral",t[t.UnaryOp=2]="UnaryOp",t[t.BinaryOp=3]="BinaryOp",t))(l||{});const I=new Map,k=new Map,F=new Map,x=new Map,M=new Map,$=new Map;function q(t){return I.has(t)}function N(t){return k.has(t)}function H(t){return F.has(t)}function _(t){return x.has(t)}function g(t){return M.has(t)}function L(t){return $.has(t)}function R(t,e){if(q(t))throw new Error(`Constant with id ${t} already exists.`);if(N(e.symbol))throw new Error(`Constant with symbol ${e.symbol} already exists.`);I.set(t,{id:t,...e}),k.set(e.symbol,{id:t,...e})}function p(t,e){if(H(t))throw new Error(`Unary operator with id ${t} already exists.`);if(_(e.symbol))throw new Error(`Unary operator with symbol ${e.symbol} already exists.`);F.set(t,{id:t,...e}),x.set(e.symbol,{id:t,...e})}function y(t,e){if(g(t))throw new Error(`Binary operator with id ${t} already exists.`);if(L(e.symbol))throw new Error(`Binary operator with symbol ${e.symbol} already exists.`);M.set(t,{id:t,...e}),$.set(e.symbol,{id:t,...e})}function G(){return[...k.keys()]}function Y(){return[...x.keys()]}function K(){return[...$.keys()]}function X(t){if(!N(t))throw new Error(`Constant with symbol ${t} is not registered.`);return k.get(t)}function u(t){if(!_(t))throw new Error(`Unary operator with symbol ${t} is not registered.`);return x.get(t)}function P(t){if(!g(t))throw new Error(`Binary operator with id ${t} is not registered.`);return M.get(t)}function U(t){if(!L(t))throw new Error(`Binary operator with symbol ${t} is not registered.`);return $.get(t)}function m(t){switch(t.type){case l.Root:return Q(t);case l.Numeral:return V(t);case l.UnaryOp:return Z(t);case l.BinaryOp:return z(t)}}function Q(t){if(!t.content)throw new SyntaxError("Evaluating empty tree.");return m(t.content)}function V(t){const e=t.numToken.symbol;return N(e)?X(e).value:Number(e)}function Z(t){if(!t.argument)throw new SyntaxError(`Unary operator lacks argument at ${t.opToken.position}.`);const e=u(t.operator.symbol).callback;return e(m(t.argument))}function z(t){if(!t.left)throw new SyntaxError(`Binary operator lacks left operand at ${t.opToken.position}.`);if(!t.right)throw new SyntaxError(`Binary operator lacks right operand at ${t.opToken.position}.`);const e=U(t.operator.symbol).callback,n=m(t.left),r=m(t.right);return e(n,r)}function v(t){const e=new et,n={index:0,tokens:t,pointer:e,position:()=>n.tokens[n.index].position};for(;n.index<t.length;){const r=t[n.index];switch(r.type){case c.Bracket:{at(r,n);break}case c.Numeral:{st(r,n);break}case c.UnaryOp:{it(r,n);break}case c.BinaryOp:{ct(r,n);break}}n.index++}return e}class S{constructor(e,n){this.type=e,this.precedence=n}clone(){const e=Object.create(Object.getPrototypeOf(this));return Object.defineProperties(e,Object.getOwnPropertyDescriptors(this)),e}}const tt=-1,A=Number.MAX_SAFE_INTEGER+1,J=Number.MAX_SAFE_INTEGER;class et extends S{$content;set content(e){this.$content=e,e.parent=this}get content(){return this.$content}constructor(){super(l.Root,tt)}toString(){return this.content?this.content.toString():"<Empty>"}toJSON(){return this.content?.toJSON()??{}}}class nt extends S{constructor(e,n){super(l.Numeral,A),this.parent=e,this.numToken=n}toString(){return`<Num> ${this.numToken}`}toJSON(){return{numeral:this.numToken.toJSON()}}}class rt extends S{constructor(e,n){super(l.UnaryOp,J),this.parent=e,this.opToken=n,this.operator=u(n.symbol)}$argument;set argument(e){this.$argument=e,e.parent=this}get argument(){return this.$argument}operator;toString(e=1){const n=`
`+"  ┃  ".repeat(e);return`<Unary>${n}UOp: ${this.opToken} (${this.operator.id})${n}Arg: ${this.argument?this.argument.toString(e+1):"<Empty>"}`}toJSON(){return{operator:{...this.opToken.toJSON(),...this.operator,type:i[this.operator.type]},argument:this.argument?.toJSON()??{}}}}class ot extends S{constructor(e,n){const r=U(n.symbol);super(l.BinaryOp,r.precedence),this.parent=e,this.opToken=n,this.operator=r}$left;$right;set left(e){this.$left=e,e.parent=this}get left(){return this.$left}set right(e){this.$right=e,e.parent=this}get right(){return this.$right}operator;toString(e=1){const n=`
`+"  ┃  ".repeat(e);return`<Binary>${n}BOp: ${this.opToken} (${this.operator.id})${n}Lft: ${this.left?this.left.toString(e+1):"<Empty>"}${n}Rgt: ${this.right?this.right.toString(e+1):"<Empty>"}`}toJSON(){return{operator:{...this.opToken.toJSON(),...this.operator},left:this.left?.toJSON()??{},right:this.right?.toJSON()??{}}}}function at(t,e){if(t.symbol===")")throw new SyntaxError(`Lone right bracket at ${e.position()}.`);if(e.pointer.type===l.Numeral)throw new SyntaxError(`Missing operator before bracket at ${e.position()}.`);const n=e.index;let r=n,o=1;for(;r<e.tokens.length-1&&(r++,!(e.tokens[r].type===c.Bracket&&(e.tokens[r].symbol==="("?o++:o--,o===0))););if(o!==0)throw new SyntaxError(`Unbalanced bracket at ${e.position()}.`);if(r===n+1)throw new SyntaxError(`Empty brackets at ${e.position()}.`);e.index=r;const a=v(e.tokens.slice(n+1,r));switch(a.content.precedence=A,e.pointer.type){case l.Root:{const s=e.pointer;e.pointer=s.content=a.content;break}case l.UnaryOp:{const s=e.pointer;e.pointer=s.argument=a.content;break}case l.BinaryOp:{const s=e.pointer;e.pointer=s.right=a.content;break}}}function st(t,e){if(e.pointer.type===l.Numeral)throw new SyntaxError(`Missing operator between numerals at ${e.position()}.`);const n=new nt(e.pointer,t);switch(e.pointer.type){case l.Root:{const r=e.pointer;e.pointer=r.content=n;break}case l.UnaryOp:{const r=e.pointer;e.pointer=r.argument=n;break}case l.BinaryOp:{const r=e.pointer;e.pointer=r.right=n;break}}}function it(t,e){for(;e.pointer.type!==l.Root&&e.pointer.precedence>J;)e.pointer=e.pointer.parent;const r=u(t.symbol).type===i.Postfix;if(r&&!(e.pointer.type===l.Root&&e.pointer.content||e.pointer.type===l.UnaryOp&&e.pointer.argument||e.pointer.type===l.BinaryOp&&e.pointer.right))throw new SyntaxError(`Missing entry before postfix unary operator at ${e.position()}.`);const o=new rt(e.pointer,t);switch(e.pointer.type){case l.Root:{const a=e.pointer;r&&(o.argument=a.content.clone()),e.pointer=a.content=o;break}case l.UnaryOp:{const a=e.pointer;r&&(o.argument=a.argument.clone()),e.pointer=a.argument=o;break}case l.BinaryOp:{const a=e.pointer;r&&(o.argument=a.right.clone()),e.pointer=a.right=o;break}}}function ct(t,e){if(e.pointer.type===l.Root)throw new SyntaxError(`Missing entry before binary operator at ${e.position()}.`);const n=U(t.symbol);for(;e.pointer.precedence>=n.precedence;)e.pointer=e.pointer.parent;const r=new ot(e.pointer,t);switch(e.pointer.type){case l.Root:{const o=e.pointer;r.left=o.content.clone(),e.pointer=o.content=r;break}case l.UnaryOp:{const o=e.pointer;r.left=o.clone(),e.pointer=o.argument=r;break}case l.BinaryOp:{const o=e.pointer;r.left=o.right.clone(),e.pointer=o.right=r;break}}}const lt=100;function b(t){if(t===1/0)return 1/0;if(t>=0&&t<lt&&Number.isInteger(t)){let e=1;for(let n=2;n<t+1;n++)e*=n;return e}return T(t+1)}function pt(t){return b(t-1)}function T(t){const n=[.9999999999998099,676.5203681218851,-1259.1392167224028,771.3234287776531,-176.6150291621406,12.507343278686905,-.13857109526572012,9984369578019572e-21,15056327351493116e-23];if(t<.5)return Math.PI/(Math.sin(Math.PI*t)*T(1-t));t--;let r=n[0];for(let s=1;s<9;s++)r+=n[s]/(t+s);const o=t+7+.5,a=Math.pow(o,t+.5);return a===1/0?1/0:Math.sqrt(2*Math.PI)*a*Math.exp(-o)*r}function j(t,e){return b(t)/b(t-e)}function yt(t,e){return j(t,e)/b(e)}function ht(t,e){if(!Number.isInteger(t)||!Number.isInteger(e))return NaN;for(;e!==0;)t>e&&([t,e]=[e,t]),e=e%t;return t}R("e",{symbol:"E",value:Math.E});R("pi",{symbol:"PI",value:Math.PI});R("inf",{symbol:"INF",value:1/0});p("pos",{symbol:"+",type:i.Prefix,callback:t=>t});p("neg",{symbol:"-",type:i.Prefix,callback:t=>-t});p("percent",{symbol:"%",type:i.Postfix,callback:t=>.01*t});p("factorial",{symbol:"!",type:i.Postfix,callback:b});p("degree",{symbol:"d",type:i.Postfix,callback:t=>Math.PI*t/180});p("abs",{symbol:"abs",type:i.Function,callback:Math.abs});p("floor",{symbol:"floor",type:i.Function,callback:Math.floor});p("ceil",{symbol:"ceil",type:i.Function,callback:Math.ceil});p("round",{symbol:"round",type:i.Function,callback:Math.round});p("sqrt",{symbol:"sqrt",type:i.Function,callback:Math.sqrt});p("exp",{symbol:"exp",type:i.Function,callback:Math.exp});p("log",{symbol:"Ln",type:i.Function,callback:Math.log});p("log10",{symbol:"log",type:i.Function,callback:Math.log10});p("sin",{symbol:"sin",type:i.Function,callback:Math.sin});p("cos",{symbol:"cos",type:i.Function,callback:Math.cos});p("tan",{symbol:"tan",type:i.Function,callback:Math.tan});p("asin",{symbol:"asin",type:i.Function,callback:Math.asin});p("acos",{symbol:"acos",type:i.Function,callback:Math.acos});p("atan",{symbol:"atan",type:i.Function,callback:Math.atan});p("gamma",{symbol:"Gamma",type:i.Function,callback:pt});y("add",{symbol:"+",callback:(t,e)=>t+e,precedence:0});y("sub",{symbol:"-",callback:(t,e)=>t-e,precedence:0});y("mul",{symbol:"*",callback:(t,e)=>t*e,precedence:1});y("div",{symbol:"/",callback:(t,e)=>t/e,precedence:1});y("int_div",{symbol:"//",callback:(t,e)=>Math.floor(t/e),precedence:1});y("pow",{symbol:"**",callback:(t,e)=>t**e,precedence:2});y("pow_alias",{symbol:"^",callback:(t,e)=>t**e,precedence:2});y("mod",{symbol:"mod",callback:(t,e)=>t%e,precedence:2});const d=100;y("min",{symbol:"min",callback:Math.min,precedence:d});y("max",{symbol:"max",callback:Math.max,precedence:d});y("permutation",{symbol:"P",callback:j,precedence:d});y("combination",{symbol:"C",callback:yt,precedence:d});y("gcd",{symbol:"gcd",callback:ht,precedence:d});function ut(t){const e=t.length,n=[];for(;t.length;){const r=e-t.length,o=bt(t,r,n);t=t.slice(o.length)}return n}class f{constructor(e,n,r){this.type=e,this.symbol=n,this.meta=r}get position(){return this.meta.from===this.meta.to?`${this.meta.from}`:`${this.meta.from}-${this.meta.to}`}toString(){return`[${this.position}] ${this.symbol}`}toJSON(){return{symbol:this.symbol,meta:this.meta}}}const B=t=>t.replaceAll(/[.*+?^${}()|[\]\\]/g,"\\$&"),ft=Object.keys(c).length/2,mt={[c.Bracket]:/[()]/,[c.Numeral]:new RegExp(`(?:${G().sort((t,e)=>e.length-t.length).map(B).join(")|(?:")})|(?:\\d+(?:\\.\\d+)?(?:[eE][+-]?\\d+)?)`),[c.UnaryOp]:new RegExp(`(?:${Y().sort((t,e)=>e.length-t.length).map(B).join(")|(?:")})`),[c.BinaryOp]:new RegExp(`(?:${K().sort((t,e)=>e.length-t.length).map(B).join(")|(?:")})`)};function bt(t,e,n){let r;for(let o=0;o<ft;o++){const a=new RegExp(`^\\s*(?:${mt[o].source})\\s*`);if(r=t.match(a)?.[0],r===void 0)continue;let s=r.trimStart();const C=e+r.length-s.length;s=s.trimEnd();const W=C+s.length-1,w={from:C,to:W},O=n.at(-1);switch(o){case c.Bracket:{if(gt(n,s,O,w))break;continue}case c.Numeral:{if(dt(n,s,O,w))break;continue}case c.UnaryOp:{if(wt(n,s,O,w))break;continue}case c.BinaryOp:{if(Ot(n,s,O,w))break;continue}}break}if(!r)throw new SyntaxError(`Invalid symbol at ${e}.`);return r}function gt(t,e,n,r){const o=n?.symbol===")"||n?.type===c.Numeral||n?.type===c.UnaryOp&&u(n.symbol).type===i.Postfix;if(e==="("&&o&&g("mul")){const s=new f(c.BinaryOp,P("mul").symbol,r);t.push(s)}const a=new f(c.Bracket,e,r);return t.push(a)}function dt(t,e,n,r){if(n?.symbol===")"||n?.type===c.Numeral||n?.type===c.UnaryOp&&u(n.symbol).type===i.Postfix)if(N(e)&&g("mul")){const s=new f(c.BinaryOp,P("mul").symbol,r);t.push(s)}else return!1;const a=new f(c.Numeral,e,r);return t.push(a)}function wt(t,e,n,r){const o=n?.symbol===")"||n?.type===c.Numeral||n?.type===c.UnaryOp&&u(n.symbol).type===i.Postfix;switch(u(e).type){case i.Prefix:{if(o)return!1;break}case i.Postfix:{if(!o)return!1;break}case i.Function:{if(!o||!g("mul"))break;const s=new f(c.BinaryOp,P("mul").symbol,r);t.push(s);break}}const a=new f(c.UnaryOp,e,r);return t.push(a)}function Ot(t,e,n,r){const o=new f(c.BinaryOp,e,r);return t.push(o)}function Et(t){const e=ut(t),n=v(e),r=m(n);return{tokens:e,tree:n,value:r}}const kt=50,E=document.getElementById("input"),h=document.getElementById("result");D(E.getAttribute("placeholder"));E.oninput=()=>D(E.value);function D(t){console.clear(),h.classList.remove("error");let e,n;try{const r=performance.now();e=Et(t.length===0?E.getAttribute("placeholder"):t),n=performance.now()-r}catch(r){h.innerHTML="",h.classList.add("error");const o=document.createElement("p");o.textContent=`${r}`.replace(/.*Error: /,""),h.appendChild(o);return}console.log(`Calculated in ${n}ms.`),console.log("<AST>",e.tree.toJSON()),console.log(`${e.tree}`),xt(e.tokens,e.value)}function xt(t,e){if(h.innerHTML="",t.reduce((r,o)=>r+o.symbol.length,0)>kt){const r=document.createElement("p");r.textContent="Expression",h.appendChild(r)}else for(const r of t){const o=document.createElement("p");o.textContent=r.symbol,o.className=c[r.type],h.appendChild(o)}const n=document.createElement("p");n.textContent=` = ${e}`,h.appendChild(n)}
